{% extends "base.html" %}
{% block content %}

<h2 class="mb-3">Charts</h2>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  /* 2 hàng: hàng 1 có 4 cột (bar), hàng 2 có 2 cột (pie) */
  .chart-row{display:grid;gap:12px;margin-bottom:12px}
  .chart-row.bar{grid-template-columns:repeat(4,minmax(0,1fr))}
  .chart-row.pie{grid-template-columns:repeat(2,minmax(0,1fr))}

  /* Responsive */
  @media(max-width:1400px){ .chart-row.bar{grid-template-columns:repeat(3,1fr)} }
  @media(max-width:992px){  .chart-row.bar{grid-template-columns:repeat(2,1fr)}
                             .chart-row.pie{grid-template-columns:1fr} }
  @media(max-width:576px){  .chart-row.bar{grid-template-columns:1fr} }

  .chart-card{background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:10px}
  .chart-card h6{margin:0 0 6px;font-weight:600;font-size:0.95rem}

  /* Thu nhỏ chiều cao canvas */
  .chart-wrap{position:relative;height:220px}
  .chart-row.pie .chart-wrap{height:240px} /* pie cao hơn chút */
</style>

<!-- Row 1: 4 bar charts -->
<div class="chart-row bar">
  <div class="chart-card">
    <h6>Tasks by Status</h6>
    <div class="chart-wrap"><canvas id="barStatus"></canvas></div>
  </div>
  <div class="chart-card">
    <h6>Top Assignees – In process</h6>
    <div class="chart-wrap"><canvas id="barIP"></canvas></div>
  </div>
  <div class="chart-card">
    <h6>Top Assignees – Done</h6>
    <div class="chart-wrap"><canvas id="barDone"></canvas></div>
  </div>
  <div class="chart-card">
    <h6>Top Assignees – OverDue</h6>
    <div class="chart-wrap"><canvas id="barOD"></canvas></div>
  </div>
</div>

<!-- Row 2: 2 pie charts -->
<div class="chart-row pie">
  <div class="chart-card">
    <h6>Status Distribution</h6>
    <div class="chart-wrap"><canvas id="pieStatus"></canvas></div>
  </div>
  <div class="chart-card">
    <h6>In-process Completion vs Remaining</h6>
    <div class="chart-wrap"><canvas id="pieInprocess"></canvas></div>
  </div>
</div>

<script>
  // ===== Data from server =====
  const statusCounts = {{ status_counts|tojson }};
  const ipLabels = {{ ip_labels|tojson }};
  const ipValues = {{ ip_values|tojson }};
  const dnLabels = {{ dn_labels|tojson }};
  const dnValues = {{ dn_values|tojson }};
  const odLabels = {{ od_labels|tojson }};
  const odValues = {{ od_values|tojson }};
  const completedSlots = {{ completed_slots|tojson }};
  const remainingSlots = {{ remaining_slots|tojson }};

  // Common options for smaller charts
  const smallBarOpts = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { maxRotation: 0, autoSkip: true, font: { size: 10 } } },
      y: { beginAtZero: true, ticks: { precision: 0, font: { size: 10 } } }
    }
  };
  const smallPieOpts = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } }
  };

  function makeBar(id, labels, values) {
    new Chart(document.getElementById(id), {
      type: 'bar',
      data: { labels, datasets: [{ data: values, label: '', borderWidth: 0 }] },
      options: smallBarOpts
    });
  }
  function makePie(id, labels, values) {
    new Chart(document.getElementById(id), {
      type: 'pie',
      data: { labels, datasets: [{ data: values }] },
      options: smallPieOpts
    });
  }

  // Bar charts
  makeBar('barStatus',
    ['In process','Done','OverDue'],
    [statusCounts['In process']||0, statusCounts['Done']||0, statusCounts['OverDue']||0]
  );
  makeBar('barIP',   ipLabels, ipValues);
  makeBar('barDone', dnLabels, dnValues);
  makeBar('barOD',   odLabels, odValues);

  // Pie charts
  makePie('pieStatus',
    ['In process','Done','OverDue'],
    [statusCounts['In process']||0, statusCounts['Done']||0, statusCounts['OverDue']||0]
  );
  makePie('pieInprocess',
    ['Completed portion (%)','Remaining portion (%)'],
    [completedSlots, remainingSlots]
  );
</script>

{% endblock %}
