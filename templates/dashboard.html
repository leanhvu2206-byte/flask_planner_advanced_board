{% extends "base.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* ===== Background ƒë·ªông ƒë·∫πp chuy√™n nghi·ªáp ===== */
  body {
    background: linear-gradient(135deg, #eef6ff, #ffffff, #e8f7f2);
    background-size: 400% 400%;
    animation: gradientBG 12s ease infinite;
  }
  @keyframes gradientBG {
    0% {background-position: 0% 50%;}
    50% {background-position: 100% 50%;}
    100% {background-position: 0% 50%;}
  }

  .quality-watermark{
    position: fixed;
    bottom: 15px;
    right: 15px;
    opacity: 0.05;
    font-size: 110px;
    pointer-events: none;
  }

  .chart-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.06);
    padding: 16px;
    height: 260px;              /* l√†m khung nh·ªè g·ªçn */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .chart-card canvas{
    max-height: 190px;          /* thu nh·ªè area bi·ªÉu ƒë·ªì */
  }

  .section-title{font-weight:700}
  .subhead{font-size:.8rem;color:#6c757d}

  /* Tooltip & dark mode friendly */
  @media (prefers-color-scheme: dark) {
    body {
      background: radial-gradient(circle at top, #1f2937, #020617);
      color: #e5e7eb;
    }
    .card, .chart-card {
      background: #0b1120;
      color:#e5e7eb;
      box-shadow: 0 4px 18px rgba(0,0,0,0.7);
    }
    .list-group-item {
      background-color:#020617;
      color:#e5e7eb;
    }
  }
</style>

<div class="quality-watermark">üß™</div>

<h2 class="mb-3">Dashboard - Quality ZVN</h2>

<div class="row g-3 mt-3">

  <!-- ==== BOARDS ==== -->
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="section-title">Boards c·ªßa b·∫°n</div>
        <div class="subhead mb-2">Danh s√°ch board b·∫°n s·ªü h·ªØu</div>

        <ul class="list-group list-group-flush">
          {% for b in boards %}
            <li class="list-group-item">
              <a href="{{ url_for('view_board', board_id=b.id) }}" class="fw-semibold">{{ b.name }}</a>
            </li>
          {% else %}
            <li class="list-group-item text-muted">Ch∆∞a c√≥ board n√†o.</li>
          {% endfor %}
        </ul>

        <a class="btn btn-primary btn-sm mt-3" href="{{ url_for('boards_page') }}">T·∫°o / m·ªü Board</a>
      </div>
    </div>
  </div>

<!-- ==== UPCOMING ‚Äì S·∫ÆP ƒê·∫æN H·∫†N ==== -->
<style>
  .upcoming-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .upcoming-table thead {
    background: #f1f5ff;
  }

  .upcoming-table th {
    padding: 10px;
    font-weight: 700;
    text-align: left;
    color: #3b4a67;
  }

  .upcoming-table tbody tr {
    border-bottom: 1px solid #e9ecef;
    transition: background 0.2s ease;
  }

  .upcoming-table tbody tr:hover {
    background: #f8fbff;
  }

  .upcoming-table td {
    padding: 10px;
    vertical-align: middle;
  }

  .status-badge {
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #fff;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .status-process { background: #0d6efd; }
  .status-done    { background: #198754; }
  .status-overdue { background: #dc3545; }

  .due-badge {
    padding: 4px 12px;
    border-radius: 999px;
    font-size: 0.78rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .due-far {
    background: #e7f7ed;
    color: #157347;
  }
  .due-soon {
    background: #fff3cd;
    color: #b26a00;
  }
  .due-overdue {
    background: #fde2e1;
    color: #b02a37;
  }

  .assignee-chip {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    margin-right: 4px;
    display: inline-block;
  }

  .upcoming-link {
    color: #0d6efd;
    font-weight: 500;
    text-decoration: none;
  }
  .upcoming-link:hover { text-decoration: underline; }
</style>

<!-- C·ªôt S·∫Øp ƒë·∫øn h·∫°n -->
  <div class="col-lg-8">
    <div class="card h-100">
      <div class="card-body">
        <div class="section-title">S·∫Øp ƒë·∫øn h·∫°n</div>
        <div class="subhead mb-3">
          Hi·ªÉn th·ªã c√°c task ƒë∆∞·ª£c ∆∞u ti√™n theo tr·∫°ng th√°i
          (<span class="text-danger fw-semibold">OverDue</span> ‚Üí In process ‚Üí Done)
          v√† ng√†y Due g·∫ßn nh·∫•t.
        </div>

        <!-- B·∫£ng nhi·ªám v·ª• -->
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Task</th>
                <th>Due date</th>
                <th>Status</th>
                <th>Assignees</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for t in upcoming %}
              <tr>
                <td class="fw-semibold">{{ t.title }}</td>

                <!-- Due date -->
                <td>
                  {% if t.status == 'OverDue' %}
                    <span class="badge bg-danger-subtle text-danger">‚è∞ {{ t.due_date }}</span>
                  {% else %}
                    <span class="badge bg-warning-subtle text-dark">üìÖ {{ t.due_date }}</span>
                  {% endif %}
                </td>

                <!-- Status -->
                <td>
                  {% if t.status == 'Done' %}
                    <span class="badge bg-success">‚úî Done</span>
                  {% elif t.status == 'In process' %}
                    <span class="badge bg-primary">‚è≥ In process</span>
                  {% else %}
                    <span class="badge bg-danger">‚ùó OverDue</span>
                  {% endif %}
                </td>

                <!-- Assignees -->
                <td>
                  {% for u in t.assignees %}
                    <span class="badge bg-light text-dark border">{{ u.name }}</span>
                  {% endfor %}
                </td>

                <td>
                  <a href="{{ url_for('view_board', board_id=t.list.board_id) }}">Xem</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

</div>



<!-- ===== BI·ªÇU ƒê·ªí ===== -->
<h3 class="mt-4 mb-2">üìä Bi·ªÉu ƒë·ªì th·ªëng k√™ t·ªïng h·ª£p</h3>

<div class="row g-3">

  <!-- Pie chart tr·∫°ng th√°i -->
  <div class="col-md-4">
    <div class="chart-card">
      <div>
        <h6 class="mb-1">Ph√¢n b·ªë tr·∫°ng th√°i</h6>
        <div class="subhead">In process / Done / OverDue</div>
      </div>
      <canvas id="pieStatus"></canvas>
    </div>
  </div>

  <!-- Pie chart ti·∫øn ƒë·ªô -->
  <div class="col-md-4">
    <div class="chart-card">
      <div>
        <h6 class="mb-1">T·ª∑ l·ªá ho√†n th√†nh</h6>
        <div class="subhead">% Done vs % c√≤n l·∫°i</div>
      </div>
      <canvas id="pieProgress"></canvas>
    </div>
  </div>

  <!-- Bar chart t·ªïng theo ng∆∞·ªùi -->
  <div class="col-md-4">
    <div class="chart-card">
      <div>
        <h6 class="mb-1">T·ªïng s·ªë task theo ng∆∞·ªùi</h6>
        <div class="subhead">S·∫Øp x·∫øp theo s·ªë l∆∞·ª£ng task</div>
      </div>
      <canvas id="barTotal"></canvas>
    </div>
  </div>

  <!-- Bar chart Done / Inprocess / Overdue -->
  <div class="col-md-4">
    <div class="chart-card">
      <div>
        <h6 class="mb-1">Ng∆∞·ªùi c√≥ nhi·ªÅu task Done</h6>
      </div>
      <canvas id="barDone"></canvas>
    </div>
  </div>

  <div class="col-md-4">
    <div class="chart-card">
      <div>
        <h6 class="mb-1">Ng∆∞·ªùi c√≥ nhi·ªÅu task In Process</h6>
      </div>
      <canvas id="barProcess"></canvas>
    </div>
  </div>

  <div class="col-md-4">
    <div class="chart-card">
      <div>
        <h6 class="mb-1">Ng∆∞·ªùi c√≥ nhi·ªÅu task OverDue</h6>
      </div>
      <canvas id="barOverdue"></canvas>
    </div>
  </div>

  <!-- So s√°nh theo th√°ng -->
  <div class="col-md-6">
    <div class="chart-card">
      <div>
        <h6 class="mb-1">So s√°nh theo th√°ng</h6>
        <div class="subhead">S·ªë task Done m·ªói th√°ng (6 th√°ng g·∫ßn nh·∫•t)</div>
      </div>
      <canvas id="lineMonthly"></canvas>
    </div>
  </div>

  <!-- Gantt "gi·∫£" timeline -->
  <div class="col-md-6">
    <div class="chart-card">
      <div>
        <h6 class="mb-1">Timeline (Gantt) - c√°c task g·∫ßn ƒë√¢y</h6>
        <div class="subhead">ƒê·ªô d√†i task (ng√†y) t·ª´ Start ƒë·∫øn Due</div>
      </div>
      <canvas id="ganttChart"></canvas>
    </div>
  </div>

</div>

<script>
  /* ==== DATA B√äN FLASK ===== */
  const inprocess = {{ total_inprocess }};
  const done = {{ total_done }};
  const overdue = {{ total_overdue }};
  const percent_done = {{ percent_done }};
  const percent_inprocess = {{ percent_inprocess }};

  const userNames = {{ user_stats | map(attribute='name') | list | tojson }};
  const doneData = {{ user_stats | map(attribute='done') | list | tojson }};
  const processData = {{ user_stats | map(attribute='inprocess') | list | tojson }};
  const overdueData = {{ user_stats | map(attribute='overdue') | list | tojson }};
  const totalData = {{ user_stats | map(attribute='total') | list | tojson }};

  /* D·ªØ li·ªáu so s√°nh theo th√°ng & gantt (c√≥ th·ªÉ ch∆∞a c√≥, d√πng default []) */
  const monthLabels = {{ month_labels|default([], true)|tojson }};
  const monthDone = {{ month_done|default([], true)|tojson }};

  const ganttLabels = {{ gantt_labels|default([], true)|tojson }};
  const ganttDurations = {{ gantt_durations|default([], true)|tojson }};   // s·ªë ng√†y
  const ganttHints = {{ gantt_hints|default([], true)|tojson }};           // "2025-11-01 ‚Üí 2025-11-05"

  /* ==== Common options: dark / light mode ==== */
  const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const baseTextColor = isDark ? '#e5e7eb' : '#212529';
  const gridColor = isDark ? 'rgba(148,163,184,0.3)' : 'rgba(148,163,184,0.4)';
  const tooltipBg = isDark ? '#020617' : '#111827';

  function withBaseOptions(config) {
    const base = {
      plugins: {
        legend: {
          labels: { color: baseTextColor, font: { size: 11 } }
        },
        tooltip: {
          backgroundColor: tooltipBg,
          titleColor: '#f9fafb',
          bodyColor: '#e5e7eb',
          borderColor: 'rgba(148,163,184,0.4)',
          borderWidth: 1,
        }
      },
      animation: {
        duration: 900,
        easing: 'easeOutCubic'
      },
      scales: {
        x: {
          ticks: { color: baseTextColor, maxRotation: 45, minRotation: 0 },
          grid: { color: gridColor }
        },
        y: {
          ticks: { color: baseTextColor },
          grid: { color: gridColor },
          beginAtZero: true
        }
      }
    };
    config.options = config.options ? {...base, ...config.options} : base;
    return config;
  }

  /* ===== PIE CHART 1 ===== */
  new Chart(
    document.getElementById('pieStatus'),
    withBaseOptions({
      type: 'pie',
      data: {
        labels: ['In Process', 'Done', 'OverDue'],
        datasets: [{
          data: [inprocess, done, overdue],
          backgroundColor: ['#0d6efd', '#198754', '#dc3545']
        }]
      },
      options: {
        plugins: {
          legend: { position: 'bottom' }
        },
        animation: { animateScale: true, animateRotate: true }
      }
    })
  );

  /* ===== PIE CHART 2 ===== */
  new Chart(
    document.getElementById('pieProgress'),
    withBaseOptions({
      type: 'doughnut',
      data: {
        labels: ['Ho√†n th√†nh', 'C√≤n l·∫°i'],
        datasets: [{
          data: [percent_done, percent_inprocess],
          backgroundColor: ['#198754', '#ffc107']
        }]
      },
      options: {
        cutout: '60%',
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.label}: ${ctx.parsed.toFixed(1)}%`
            }
          }
        }
      }
    })
  );

  /* ===== BAR CHART helper ===== */
  function makeBar(id, label, data, color){
    const el = document.getElementById(id);
    if (!el) return;
    new Chart(
      el,
      withBaseOptions({
        type: 'bar',
        data: {
          labels: userNames,
          datasets: [{
            label: label,
            data: data,
            backgroundColor: color,
            borderRadius: 6
          }]
        },
        options: {
          plugins: {
            legend: { display:false }
          }
        }
      })
    );
  }

  makeBar("barDone", "Done", doneData, "#198754");
  makeBar("barProcess", "In process", processData, "#0d6efd");
  makeBar("barOverdue", "OverDue", overdueData, "#dc3545");
  makeBar("barTotal", "Total", totalData, "#6f42c1");

  /* ===== LINE ‚Äì SO S√ÅNH THEO TH√ÅNG ===== */
  if (monthLabels.length && monthDone.length){
    new Chart(
      document.getElementById('lineMonthly'),
      withBaseOptions({
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: 'Task Done',
            data: monthDone,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34,197,94,.25)',
            tension: 0.35,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 5
          }]
        },
        options: {
          plugins: {
            legend: { display:true }
          }
        }
      })
    );
  }

  /* ===== GANTT "GI·∫¢" ===== */
  if (ganttLabels.length && ganttDurations.length){
    new Chart(
      document.getElementById('ganttChart'),
      withBaseOptions({
        type: 'bar',
        data: {
          labels: ganttLabels,
          datasets: [{
            label: 'S·ªë ng√†y th·ª±c hi·ªán',
            data: ganttDurations,
            backgroundColor: '#0dcaf0',
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          plugins: {
            tooltip: {
              callbacks: {
                label: function(ctx){
                  const d = ctx.parsed.x;
                  const hint = ganttHints[ctx.dataIndex] || '';
                  return ` ${d} ng√†y ${hint ? '('+hint+')' : ''}`;
                }
              }
            }
          }
        }
      })
    );
  }
</script>

{% endblock %}
