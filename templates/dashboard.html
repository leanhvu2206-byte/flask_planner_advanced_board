{% extends "base.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* ===== Background ƒë·ªông ƒë·∫πp chuy√™n nghi·ªáp ===== */
  body {
    background: linear-gradient(135deg, #eef6ff, #ffffff, #e8f7f2);
    background-size: 400% 400%;
    animation: gradientBG 12s ease infinite;
  }
  @keyframes gradientBG {
    0% {background-position: 0% 50%;}
    50% {background-position: 100% 50%;}
    100% {background-position: 0% 50%;}
  }

  .quality-watermark{
    position: fixed;
    bottom: 15px;
    right: 15px;
    opacity: 0.05;
    font-size: 110px;
    pointer-events: none;
  }

  .chart-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.06);
    padding: 18px;
  }

  .section-title{font-weight:700}
  .subhead{font-size:.8rem;color:#6c757d}
</style>

<div class="quality-watermark">üß™</div>

<h2 class="mb-3">Dashboard - Quality ZVN</h2>

<div class="row g-3">

  <!-- ==== BOARDS ==== -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-end">
          <div>
            <div class="section-title">Boards c·ªßa b·∫°n</div>
            <div class="subhead">Danh s√°ch board b·∫°n s·ªü h·ªØu</div>
          </div>
          <a class="btn btn-primary btn-sm" href="{{ url_for('boards_page') }}">T·∫°o / m·ªü Board</a>
        </div>
        <hr>
        <ul class="list-group list-group-flush">
          {% for b in boards %}
          <li class="list-group-item">
            <a href="{{ url_for('view_board', board_id=b.id) }}" class="fw-semibold">{{ b.name }}</a>
          </li>
          {% else %}
          <li class="list-group-item text-muted">Ch∆∞a c√≥ board n√†o.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- ==== UPCOMING ==== -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-body">
        <div class="section-title">S·∫Øp ƒë·∫øn h·∫°n</div>
        <div class="subhead mb-2">Hi·ªÉn th·ªã c√°c task c√≥ ng√†y Due g·∫ßn nh·∫•t</div>

        <ul class="list-group list-group-flush">
          {% for t in upcoming %}
          <li class="list-group-item d-flex align-items-center justify-content-between">
            <div class="fw-semibold">{{ t.title }}</div>
            <span>{{ t.due_date }}</span>
            <span class="badge bg-info">{{ t.status }}</span>
            <span>
              {% for u in t.assignees %}
              <span class="badge bg-light text-dark border">{{ u.name }}</span>
              {% endfor %}
            </span>
            <a href="{{ url_for('view_board', board_id=t.list.board_id) }}">Xem</a>
          </li>
          {% else %}
          <li class="list-group-item text-muted">Kh√¥ng c√≥ task ƒë·∫øn h·∫°n.</li>
          {% endfor %}
        </ul>

      </div>
    </div>
  </div>
</div>


<!-- ===== BI·ªÇU ƒê·ªí ===== -->
<h3 class="mt-4 mb-2">üìä Bi·ªÉu ƒë·ªì th·ªëng k√™ t·ªïng h·ª£p</h3>

<div class="row g-3">

  <!-- Pie chart tr·∫°ng th√°i -->
  <div class="col-md-6">
    <div class="chart-card">
      <h5>Ph√¢n b·ªë tr·∫°ng th√°i c√¥ng vi·ªác</h5>
      <canvas id="pieStatus"></canvas>
    </div>
  </div>

  <!-- Pie chart ti·∫øn ƒë·ªô -->
  <div class="col-md-6">
    <div class="chart-card">
      <h5>T·ª∑ l·ªá ho√†n th√†nh</h5>
      <canvas id="pieProgress"></canvas>
    </div>
  </div>

  <!-- Bar chart -->
  <div class="col-md-6">
    <div class="chart-card">
      <h5>Ng∆∞·ªùi c√≥ nhi·ªÅu task Done nh·∫•t</h5>
      <canvas id="barDone"></canvas>
    </div>
  </div>

  <div class="col-md-6">
    <div class="chart-card">
      <h5>Ng∆∞·ªùi c√≥ nhi·ªÅu task In Process nh·∫•t</h5>
      <canvas id="barProcess"></canvas>
    </div>
  </div>

  <div class="col-md-6">
    <div class="chart-card">
      <h5>Ng∆∞·ªùi c√≥ nhi·ªÅu task OverDue nh·∫•t</h5>
      <canvas id="barOverdue"></canvas>
    </div>
  </div>

  <div class="col-md-6">
    <div class="chart-card">
      <h5>T·ªïng s·ªë task theo ng∆∞·ªùi</h5>
      <canvas id="barTotal"></canvas>
    </div>
  </div>

</div>

<script>
  /* ==== DATA B√äN FLASK ===== */
  const inprocess = {{ total_inprocess }};
  const done = {{ total_done }};
  const overdue = {{ total_overdue }};
  const percent_done = {{ percent_done }};
  const percent_inprocess = {{ percent_inprocess }};

  const userNames = {{ user_stats | map(attribute='name') | list | tojson }};
  const doneData = {{ user_stats | map(attribute='done') | list | tojson }};
  const processData = {{ user_stats | map(attribute='inprocess') | list | tojson }};
  const overdueData = {{ user_stats | map(attribute='overdue') | list | tojson }};
  const totalData = {{ user_stats | map(attribute='total') | list | tojson }};

  /* ===== PIE CHART 1 ===== */
  new Chart(document.getElementById('pieStatus'), {
    type: 'pie',
    data: {
      labels: ['In Process', 'Done', 'OverDue'],
      datasets: [{
        data: [inprocess, done, overdue],
        backgroundColor: ['#0d6efd', '#198754', '#dc3545']
      }]
    }
  });

  /* ===== PIE CHART 2 ===== */
  new Chart(document.getElementById('pieProgress'), {
    type: 'doughnut',
    data: {
      labels: ['Ho√†n th√†nh', 'C√≤n l·∫°i'],
      datasets: [{
        data: [percent_done, percent_inprocess],
        backgroundColor: ['#198754', '#ffc107']
      }]
    }
  });

  /* ===== BAR CHART ===== */
  function makeBar(id, data, color) {
    new Chart(document.getElementById(id), {
      type: 'bar',
      data: {
        labels: userNames,
        datasets: [{
          data: data,
          backgroundColor: color
        }]
      },
      options: {
        responsive:true,
        scales:{y:{beginAtZero:true}},
        plugins:{legend:{display:false}}
      }
    });
  }

  makeBar("barDone", doneData, "#198754");
  makeBar("barProcess", processData, "#0d6efd");
  makeBar("barOverdue", overdueData, "#dc3545");
  makeBar("barTotal", totalData, "#6f42c1");
</script>

{% endblock %}
